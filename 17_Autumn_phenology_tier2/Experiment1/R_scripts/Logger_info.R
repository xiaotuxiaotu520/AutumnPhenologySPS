##############################################################################################################################################
############################################################# Rscript for: ###################################################################
##############################################################################################################################################
#### Insert publication name #################################################################################################################
##############################################################################################################################################
# This script extracts the climate information for photosynthesis settings ###################################################################
##############################################################################################################################################



#required packages
require(tidyverse)
require(data.table)



##############################################################################################################################################
##############################################################################################################################################



#####################
## Set directories ##
#####################



# set the working directory
setwd("/Users/consti/Desktop/PhD/Publication_material/17_Autumn_phenology_tier2/Experiment1")

# paths
climate_path   = "Data/Climate"
output_path    = "Data/Photosynthesis_settings"



##############################################################################################################################################
##############################################################################################################################################



#################
## Import data ##
#################



# Rbind HOBO logger info
########################

#check how many files there are
length(list.files(path=climate_path, pattern='.csv'))

#Rbind files
climate.df = rbindlist(lapply(list.files(path = climate_path, pattern='.csv'), 
                                         function(n) fread(file.path(climate_path, n))))



##############################################################################################################################################
##############################################################################################################################################



####################
## Data wrangling ##
####################



climate.df = climate.df %>%
  #separate date/time column
  separate(date, into = c("date","time"), sep=" ") %>%
  #set date as date and time as numeric
  mutate(date = lubridate::dmy(date),
         time = as.numeric(gsub("\\:.*","", time)) ) 



##############################################################################################################################################
##############################################################################################################################################



###################
## Summary table ##
###################



#vector of desired variables
VariablesVector = c("temp","lux")
#summarize
summary.df = climate.df %>% 
  #keep only measurements 10 days before measurement and from 9-14 o'clock
  filter(time >8 & time <15,
         date < '2021-08-23') %>% 
  #get treatment-level means
  group_by(treatment, measurement) %>% 
  summarize_at(VariablesVector, mean, na.rm = TRUE) %>%
  #get PAR and round
  #http://www.egc.com/useful_info_lighting.php
  mutate(PAR  = round(ifelse(treatment == "chamber", lux * 0.030, lux * 0.019)),
         temp = round(temp,1),
         lux  = round(lux) )

#print
as.data.frame(summary.df) %>%
  filter(measurement==4)



##############################################################################################################################################
##############################################################################################################################################



##########
## Safe ##
##########



write.csv(summary.df
          %>%filter(measurement==1), 
          paste(output_path, "Measurement1.csv", sep="/"))

write.csv(summary.df
          %>%filter(measurement==2), 
          paste(output_path, "Measurement2.csv", sep="/"))

write.csv(summary.df
          %>%filter(measurement==3), 
          paste(output_path, "Measurement3.csv", sep="/"))

write.csv(summary.df
          %>%filter(measurement==4), 
          paste(output_path, "Measurement4.csv", sep="/"))



##############################################################################################################################################
##############################################################################################################################################



